'use strict';

angular.module('d3', [])

//- Injects D3 as a Service
.factory('d3Serv', ['$document', '$q', '$rootScope', function ($document, $q, $rootScope) {
	var d = $q.defer();
	function onScriptLoad() {
		// Load client in the browser
		$rootScope.$apply(function () {
			d.resolve(window.d3);
		});
	}
	// Create a script tag with d3 as the source
	// and call our onScriptLoad callback when it
	// has been loaded
	var scriptTag = $document[0].createElement('script');
	scriptTag.type = 'text/javascript';
	scriptTag.async = true;
	scriptTag.src = 'http://d3js.org/d3.v3.min.js';
	scriptTag.onreadystatechange = function () {
		if (this.readyState == 'complete') onScriptLoad();
	};
	scriptTag.onload = onScriptLoad;

	var s = $document[0].getElementsByTagName('body')[0];
	s.appendChild(scriptTag);

	return {
		d3: function d3() {
			return d.promise;
		}
	};
}]);

angular.module('MapD3').directive('map', function (d3Serv, $q) {
	return {
		restrict: 'E',
		scope: {},
		link: function link(scope, element, attrs) {
			d3Serv.d3().then(function (d3) {

				element = element[0];
				var width = 1000;
				var height = 700;
				var color = d3.scale.category20();

				var svg = d3.select(element).append('svg').attr('width', width).attr('height', height);

				var projection = d3.geo.mercator().scale((width + 1) / 2 / Math.PI).translate([width / 2, height / 2]).precision(.1);

				var path = d3.geo.path().projection(projection);

				d3.json('mapdata/world.json', function (err, globe) {
					var neighbors = topojson.neighbors(globe.objects.countries.geometries);
					var countries = topojson.feature(globe, globe.objects.countries).features;

					svg.selectAll('.country').data(countries).enter().insert('path').attr('class', 'country').attr('d', path).style('fill', function (d, i) {
						return color(d.color = d3.max(neighbors[i], function (n) {
							return countries[n].color;
						}) + 1 | 0);
					});

					svg.insert('path').datum(topojson.mesh(globe, globe.objects.countries, function (a, b) {
						return a !== b;
					})).attr('class', 'boundary').attr('d', path);
				});
			});
		}
	};
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInNyYy9qcy9kaXJlY3RpdmVzL21hcC5kaXJlY3RpdmUuanMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFBQSxPQUFPLENBRU4sTUFBTSxDQUFDLElBQUksRUFBRSxFQUFFLENBQUM7OztDQUdoQixPQUFPLENBQUMsUUFBUSxFQUFFLENBQUMsV0FBVyxFQUFFLElBQUksRUFBRSxZQUFZLEVBQy9DLFVBQVMsU0FBUyxFQUFFLEVBQUUsRUFBRSxVQUFVLEVBQUU7QUFDbEMsS0FBSSxDQUFDLEdBQUcsRUFBRSxDQUFDLEtBQUssRUFBRSxDQUFDO0FBQ25CLFVBQVMsWUFBWSxHQUFHOztBQUV0QixZQUFVLENBQUMsTUFBTSxDQUFDLFlBQVc7QUFBRSxJQUFDLENBQUMsT0FBTyxDQUFDLE1BQU0sQ0FBQyxFQUFFLENBQUMsQ0FBQztHQUFFLENBQUMsQ0FBQztFQUN6RDs7OztBQUlELEtBQUksU0FBUyxHQUFHLFNBQVMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxhQUFhLENBQUMsUUFBUSxDQUFDLENBQUM7QUFDckQsVUFBUyxDQUFDLElBQUksR0FBRyxpQkFBaUIsQ0FBQztBQUNuQyxVQUFTLENBQUMsS0FBSyxHQUFHLElBQUksQ0FBQztBQUN2QixVQUFTLENBQUMsR0FBRyxHQUFHLDhCQUE4QixDQUFDO0FBQy9DLFVBQVMsQ0FBQyxrQkFBa0IsR0FBRyxZQUFZO0FBQ3pDLE1BQUksSUFBSSxDQUFDLFVBQVUsSUFBSSxVQUFVLEVBQUUsWUFBWSxFQUFFLENBQUM7RUFDbkQsQ0FBQTtBQUNELFVBQVMsQ0FBQyxNQUFNLEdBQUcsWUFBWSxDQUFDOztBQUVoQyxLQUFJLENBQUMsR0FBRyxTQUFTLENBQUMsQ0FBQyxDQUFDLENBQUMsb0JBQW9CLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7QUFDckQsRUFBQyxDQUFDLFdBQVcsQ0FBQyxTQUFTLENBQUMsQ0FBQzs7QUFFekIsUUFBTztBQUNMLElBQUUsRUFBRSxjQUFXO0FBQUUsVUFBTyxDQUFDLENB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QUFDLENBQ3pCLElBQUksQ0FBQyxHQUFHLEVBQUUsSUFBSSxDQUFDLENBQUM7S0FHakIsQ0FBQyxDQUFBO0lBRUYsQ0FBQyxDQUFBO0dBRUw7RUFDRCxDQUFBO0NBQ0QsQ0FBQyxDQUFBIiwiZmlsZSI6InNyYy9qcy9kaXJlY3RpdmVzL21hcC5kaXJlY3RpdmUuanMiLCJzb3VyY2VzQ29udGVudCI6WyJhbmd1bGFyXG5cbi5tb2R1bGUoJ2QzJywgW10pXG5cbi8vLSBJbmplY3RzIEQzIGFzIGEgU2VydmljZVxuLmZhY3RvcnkoJ2QzU2VydicsIFsnJGRvY3VtZW50JywgJyRxJywgJyRyb290U2NvcGUnLFxuICAgIGZ1bmN0aW9uKCRkb2N1bWVudCwgJHEsICRyb290U2NvcGUpIHtcbiAgICAgIHZhciBkID0gJHEuZGVmZXIoKTtcbiAgICAgIGZ1bmN0aW9uIG9uU2NyaXB0TG9hZCgpIHtcbiAgICAgICAgLy8gTG9hZCBjbGllbnQgaW4gdGhlIGJyb3dzZXJcbiAgICAgICAgJHJvb3RTY29wZS4kYXBwbHkoZnVuY3Rpb24oKSB7IGQucmVzb2x2ZSh3aW5kb3cuZDMpOyB9KTtcbiAgICAgIH1cbiAgICAgIC8vIENyZWF0ZSBhIHNjcmlwdCB0YWcgd2l0aCBkMyBhcyB0aGUgc291cmNlXG4gICAgICAvLyBhbmQgY2FsbCBvdXIgb25TY3JpcHRMb2FkIGNhbGxiYWNrIHdoZW4gaXRcbiAgICAgIC8vIGhhcyBiZWVuIGxvYWRlZFxuICAgICAgdmFyIHNjcmlwdFRhZyA9ICRkb2N1bWVudFswXS5jcmVhdGVFbGVtZW50KCdzY3JpcHQnKTtcbiAgICAgIHNjcmlwdFRhZy50eXBlID0gJ3RleHQvamF2YXNjcmlwdCc7IFxuICAgICAgc2NyaXB0VGFnLmFzeW5jID0gdHJ1ZTtcbiAgICAgIHNjcmlwdFRhZy5zcmMgPSAnaHR0cDovL2QzanMub3JnL2QzLnYzLm1pbi5qcyc7XG4gICAgICBzY3JpcHRUYWcub25yZWFkeXN0YXRlY2hhbmdlID0gZnVuY3Rpb24gKCkge1xuICAgICAgICBpZiAodGhpcy5yZWFkeVN0YXRlID09ICdjb21wbGV0ZScpIG9uU2NyaXB0TG9hZCgpO1xuICAgICAgfVxuICAgICAgc2NyaXB0VGFnLm9ubG9hZCA9IG9uU2NyaXB0TG9hZDtcblxuICAgICAgdmFyIHMgPSAkZG9jdW1lbnRbMF0uZ2V0RWxlbWVudHNCeVRhZ05hbWUoJ2JvZHknKVswXTtcbiAgICAgIHMuYXBwZW5kQ2hpbGQoc2NyaXB0VGFnKTtcblxuICAgICAgcmV0dXJuIHtcbiAgICAgICAgZDM6IGZ1bmN0aW9uKCkgeyByZXR1cm4gZC5wcm9taXNlOyB9XG4gICAgICB9O1xufV0pO1xuXG5hbmd1bGFyXG5cbi5tb2R1bGUoJ01hcEQzJylcblxuLmRpcmVjdGl2ZSgnbWFwJywgZnVuY3Rpb24gKGQzU2VydiwgJHEpIHtcblx0cmV0dXJuIHtcblx0XHRyZXN0cmljdDogJ0UnLFxuXHRcdHNjb3BlOiB7fSxcblx0XHRsaW5rOiBmdW5jdGlvbihzY29wZSwgZWxlbWVudCwgYXR0cnMpIHtcblx0XHRcdGQzU2Vydi5kMygpLnRoZW4oZnVuY3Rpb24oZDMpIHtcblxuXHRcdFx0XHRlbGVtZW50ID0gZWxlbWVudFswXVxuXHRcdFx0XHR2YXIgd2lkdGggPSAxMDAwO1xuXHRcdFx0XHR2YXIgaGVpZ2h0ID0gNzAwO1xuXHRcdFx0XHR2YXIgY29sb3IgPSBkMy5zY2FsZS5jYXRlZ29yeTIwKClcblxuXHRcdFx0XHR2YXIgc3ZnID0gZDMuc2VsZWN0KGVsZW1lbnQpXG5cdFx0XHRcdFx0XHRcdC5hcHBlbmQoXCJzdmdcIilcblx0XHRcdFx0XHRcdFx0LmF0dHIoXCJ3aWR0aFwiLCB3aWR0aClcblx0XHRcdFx0XHRcdFx0LmF0dHIoXCJoZWlnaHRcIiwgaGVpZ2h0KVxuXG5cdFx0XHRcdHZhciBwcm9qZWN0aW9uID0gZDMuZ2VvLm1lcmNhdG9yKClcblx0XHRcdFx0ICAgIFx0XHRcdC5zY2FsZSgod2lkdGggKyAxKSAvIDIgLyBNYXRoLlBJKVxuXHQgICAgXHRcdFx0XHRcdFx0LnRyYW5zbGF0ZShbd2lkdGggLyAyLCBoZWlnaHQgLyAyXSlcblx0ICAgIFx0XHRcdFx0XHRcdC5wcmVjaXNpb24oLjEpXG5cblx0ICAgIFx0XHR2YXIgcGF0aCA9IGQzLmdlby5wYXRoKClcblx0ICAgIFx0XHRcdFx0XHQucHJvamVjdGlvbihwcm9qZWN0aW9uKVxuXG5cblx0ICAgIFx0XHRkMy5qc29uKCdtYXBkYXRhL3dvcmxkLmpzb24nLCBmdW5jdGlvbiAoZXJyLCBnbG9iZSl7XG5cdCAgICBcdFx0XHR2YXIgbmVpZ2hib3JzID0gdG9wb2pzb24ubmVpZ2hib3JzKGdsb2JlLm9iamVjdHMuY291bnRyaWVzLmdlb21ldHJpZXMpXG5cdCAgICBcdFx0XHR2YXIgY291bnRyaWVzID0gdG9wb2pzb24uZmVhdHVyZShnbG9iZSwgZ2xvYmUub2JqZWN0cy5jb3VudHJpZXMpLmZlYXR1cmVzXG5cblx0ICAgIFx0XHRcdHN2Zy5zZWxlY3RBbGwoXCIuY291bnRyeVwiKVxuXHRcdFx0XHQgICAgLmRhdGEoY291bnRyaWVzKVxuXHRcdFx0XHQgICAgLmVudGVyKCkuaW5zZXJ0KFwicGF0aFwiKVxuXHRcdFx0ICAgIFx0LmF0dHIoXCJjbGFzc1wiLCBcImNvdW50cnlcIilcblx0XHRcdCAgICBcdC5hdHRyKFwiZFwiLCBwYXRoKVxuXHRcdFx0ICAgIFx0LnN0eWxlKFwiZmlsbFwiLCBmdW5jdGlvbihkLCBpKSB7IHJldHVybiBjb2xvcihkLmNvbG9yID0gZDMubWF4KG5laWdoYm9yc1tpXSwgZnVuY3Rpb24obikgeyByZXR1cm4gY291bnRyaWVzW25dLmNvbG9yOyB9KSArIDEgfCAwKTsgfSk7XG5cblx0XHRcdFx0ICBcdHN2Zy5pbnNlcnQoXCJwYXRoXCIpXG5cdFx0XHRcdCAgICAuZGF0dW0odG9wb2pzb24ubWVzaChnbG9iZSwgZ2xvYmUub2JqZWN0cy5jb3VudHJpZXMsIGZ1bmN0aW9uKGEsIGIpIHsgcmV0dXJuIGEgIT09IGI7IH0pKVxuXHRcdFx0XHQgICAgLmF0dHIoXCJjbGFzc1wiLCBcImJvdW5kYXJ5XCIpXG5cdFx0XHRcdCAgICAuYXR0cihcImRcIiwgcGF0aCk7XG5cblx0XHQgICAgXHRcdFx0XG5cdCAgICBcdFx0fSlcblxuXHQgICAgXHR9KVxuXHRcdFx0XG5cdFx0fVxuXHR9XG59KSJdfQ==
