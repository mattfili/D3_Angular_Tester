'use strict';

angular.module('d3', [])

//- assures d3 works onload and async
.factory('d3Serv', ['$document', '$q', '$rootScope', function ($document, $q, $rootScope) {
	var d = $q.defer();
	function onScriptLoad() {
		// Load client in the browser
		$rootScope.$apply(function () {
			d.resolve(window.d3);
		});
	}
	// Create a script tag with d3 as the source
	// and call our onScriptLoad callback when it
	// has been loaded
	var scriptTag = $document[0].createElement('script');
	scriptTag.type = 'text/javascript';
	scriptTag.async = true;
	scriptTag.src = 'http://d3js.org/d3.v3.min.js';
	scriptTag.onreadystatechange = function () {
		if (this.readyState == 'complete') onScriptLoad();
	};
	scriptTag.onload = onScriptLoad;

	var s = $document[0].getElementsByTagName('body')[0];
	s.appendChild(scriptTag);

	return {
		d3: function d3() {
			return d.promise;
		}
	};
}]);

angular.module('MapD3').directive('map', function (d3Serv, $q) {
	return {
		restrict: 'E',
		scope: {},
		link: function link(scope, element, attrs) {
			d3Serv.d3().then(function (d3) {

				element = element[0];
				var width = 1000;
				var height = 700;
				var color = d3.scale.category20();

				var svg = d3.select(element).append('svg').attr('width', width).attr('height', height);

				var projection = d3.geo.mercator().scale((width + 1) / 2 / Math.PI).translate([width / 2, height / 2]).precision(.1);

				var path = d3.geo.path().projection(projection);

				d3.json('mapdata/world.json', function (err, globe) {
					var neighbors = topojson.neighbors(globe.objects.countries.geometries);
					var countries = topojson.feature(globe, globe.objects.countries).features;

					svg.selectAll('.country').data(countries).enter().insert('path').attr('class', 'country').attr('d', path).style('fill', function (d, i) {
						return color(d.color = d3.max(neighbors[i], function (n) {
							return countries[n].color;
						}) + 1 | 0);
					});

					svg.insert('path').datum(topojson.mesh(globe, globe.objects.countries, function (a, b) {
						return a !== b;
					})).attr('class', 'boundary').attr('d', path);

					// var world = svg.append('g')
					// 				.selectAll('g')
					// 				.data(topojson.feature(globe, globe.objects.subunits).features)
					// 				.enter()
					// 				.append("g")

					// 				console.log(globe.objects)

					//  			world.append('path')
					//  				.attr('class', 'world')
					//  				.attr('d', path);

					//  			svg.append('path')
					//  				.datum(topojson.mesh(globe, globe.objects.subunits), function(a,b) {return a!==b})
					//  				.attr('d', path)
					//  				.attr('class', 'subunit-boundary')
				});
			});
		}
	};
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInNyYy9qcy9kaXJlY3RpdmVzL21hcC5kaXJlY3RpdmUuanMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFBQSxPQUFPLENBRU4sTUFBTSxDQUFDLElBQUksRUFBRSxFQUFFLENBQUM7OztDQUdoQixPQUFPLENBQUMsUUFBUSxFQUFFLENBQUMsV0FBVyxFQUFFLElBQUksRUFBRSxZQUFZLEVBQy9DLFVBQVMsU0FBUyxFQUFFLEVBQUUsRUFBRSxVQUFVLEVBQUU7QUFDbEMsS0FBSSxDQUFDLEdBQUcsRUFBRSxDQUFDLEtBQUssRUFBRSxDQUFDO0FBQ25CLFVBQVMsWUFBWSxHQUFHOztBQUV0QixZQUFVLENBQUMsTUFBTSxDQUFDLFlBQVc7QUFBRSxJQUFDLENBQUMsT0FBTyxDQUFDLE1BQU0sQ0FBQyxFQUFFLENBQUMsQ0FBQztHQUFFLENBQUMsQ0FBQztFQUN6RDs7OztBQUlELEtBQUksU0FBUyxHQUFHLFNBQVMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxhQUFhLENBQUMsUUFBUSxDQUFDLENBQUM7QUFDckQsVUFBUyxDQUFDLElBQUksR0FBRyxpQkFBaUIsQ0FBQztBQUNuQyxVQUFTLENBQUMsS0FBSyxHQUFHLElBQUksQ0FBQztBQUN2QixVQUFTLENBQUMsR0FBRyxHQUFHLDhCQUE4QixDQUFDO0FBQy9DLFVBQVMsQ0FBQyxrQkFBa0IsR0FBRyxZQUFZO0FBQ3pDLE1BQUksSUFBSSxDQUFDLFVBQVUsSUFBSSxVQUFVLEVBQUUsWUFBWSxFQUFFLENBQUM7RUFDbkQsQ0FBQTtBQUNELFVBQVMsQ0FBQyxNQUFNLEdBQUcsWUFBWSxDQUFDOztBQUVoQyxLQUFJLENBQUMsR0FBRyxTQUFTLENBQUMsQ0FBQyxDQUFDLENBQUMsb0JBQW9CLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7QUFDckQsRUFBQyxDQUFDLFdBQVcsQ0FBQyxTQUFTLENBQUMsQ0FBQzs7QUFFekIsUUFBTztBQUNMLElBQUUsRUFBRSxjQUFXO0FBQUUsVUFBTyxDQUFDLENB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QUFDLENBQ3pCLElBQUksQ0FBQyxHQUFHLEVBQUUsSUFBSSxDQUFDLENBQUM7Ozs7Ozs7Ozs7Ozs7Ozs7OztLQTJCakIsQ0FBQyxDQUFBO0lBRUYsQ0FBQyxDQUFBO0dBT0o7RUFDRixDQUFBO0NBQ0QsQ0FBQyxDQUFBIiwiZmlsZSI6InNyYy9qcy9kaXJlY3RpdmVzL21hcC5kaXJlY3RpdmUuanMiLCJzb3VyY2VzQ29udGVudCI6WyJhbmd1bGFyXG5cbi5tb2R1bGUoJ2QzJywgW10pXG5cbi8vLSBhc3N1cmVzIGQzIHdvcmtzIG9ubG9hZCBhbmQgYXN5bmNcbi5mYWN0b3J5KCdkM1NlcnYnLCBbJyRkb2N1bWVudCcsICckcScsICckcm9vdFNjb3BlJyxcbiAgICBmdW5jdGlvbigkZG9jdW1lbnQsICRxLCAkcm9vdFNjb3BlKSB7XG4gICAgICB2YXIgZCA9ICRxLmRlZmVyKCk7XG4gICAgICBmdW5jdGlvbiBvblNjcmlwdExvYWQoKSB7XG4gICAgICAgIC8vIExvYWQgY2xpZW50IGluIHRoZSBicm93c2VyXG4gICAgICAgICRyb290U2NvcGUuJGFwcGx5KGZ1bmN0aW9uKCkgeyBkLnJlc29sdmUod2luZG93LmQzKTsgfSk7XG4gICAgICB9XG4gICAgICAvLyBDcmVhdGUgYSBzY3JpcHQgdGFnIHdpdGggZDMgYXMgdGhlIHNvdXJjZVxuICAgICAgLy8gYW5kIGNhbGwgb3VyIG9uU2NyaXB0TG9hZCBjYWxsYmFjayB3aGVuIGl0XG4gICAgICAvLyBoYXMgYmVlbiBsb2FkZWRcbiAgICAgIHZhciBzY3JpcHRUYWcgPSAkZG9jdW1lbnRbMF0uY3JlYXRlRWxlbWVudCgnc2NyaXB0Jyk7XG4gICAgICBzY3JpcHRUYWcudHlwZSA9ICd0ZXh0L2phdmFzY3JpcHQnOyBcbiAgICAgIHNjcmlwdFRhZy5hc3luYyA9IHRydWU7XG4gICAgICBzY3JpcHRUYWcuc3JjID0gJ2h0dHA6Ly9kM2pzLm9yZy9kMy52My5taW4uanMnO1xuICAgICAgc2NyaXB0VGFnLm9ucmVhZHlzdGF0ZWNoYW5nZSA9IGZ1bmN0aW9uICgpIHtcbiAgICAgICAgaWYgKHRoaXMucmVhZHlTdGF0ZSA9PSAnY29tcGxldGUnKSBvblNjcmlwdExvYWQoKTtcbiAgICAgIH1cbiAgICAgIHNjcmlwdFRhZy5vbmxvYWQgPSBvblNjcmlwdExvYWQ7XG5cbiAgICAgIHZhciBzID0gJGRvY3VtZW50WzBdLmdldEVsZW1lbnRzQnlUYWdOYW1lKCdib2R5JylbMF07XG4gICAgICBzLmFwcGVuZENoaWxkKHNjcmlwdFRhZyk7XG5cbiAgICAgIHJldHVybiB7XG4gICAgICAgIGQzOiBmdW5jdGlvbigpIHsgcmV0dXJuIGQucHJvbWlzZTsgfVxuICAgICAgfTtcbn1dKTtcblxuYW5ndWxhclxuXG4ubW9kdWxlKCdNYXBEMycpXG5cbi5kaXJlY3RpdmUoJ21hcCcsIGZ1bmN0aW9uIChkM1NlcnYsICRxKSB7XG5cdHJldHVybiB7XG5cdFx0cmVzdHJpY3Q6ICdFJyxcblx0XHRzY29wZToge30sXG5cdFx0bGluazogZnVuY3Rpb24oc2NvcGUsIGVsZW1lbnQsIGF0dHJzKSB7XG5cdFx0XHRkM1NlcnYuZDMoKS50aGVuKGZ1bmN0aW9uKGQzKSB7XG5cblx0XHRcdFx0ZWxlbWVudCA9IGVsZW1lbnRbMF1cblx0XHRcdFx0dmFyIHdpZHRoID0gMTAwMDtcblx0XHRcdFx0dmFyIGhlaWdodCA9IDcwMDtcblx0XHRcdFx0dmFyIGNvbG9yID0gZDMuc2NhbGUuY2F0ZWdvcnkyMCgpXG5cblx0XHRcdFx0dmFyIHN2ZyA9IGQzLnNlbGVjdChlbGVtZW50KVxuXHRcdFx0XHRcdFx0XHQuYXBwZW5kKFwic3ZnXCIpXG5cdFx0XHRcdFx0XHRcdC5hdHRyKFwid2lkdGhcIiwgd2lkdGgpXG5cdFx0XHRcdFx0XHRcdC5hdHRyKFwiaGVpZ2h0XCIsIGhlaWdodClcblxuXHRcdFx0XHR2YXIgcHJvamVjdGlvbiA9IGQzLmdlby5tZXJjYXRvcigpXG5cdFx0XHRcdCAgICBcdFx0XHQuc2NhbGUoKHdpZHRoICsgMSkgLyAyIC8gTWF0aC5QSSlcblx0ICAgIFx0XHRcdFx0XHRcdC50cmFuc2xhdGUoW3dpZHRoIC8gMiwgaGVpZ2h0IC8gMl0pXG5cdCAgICBcdFx0XHRcdFx0XHQucHJlY2lzaW9uKC4xKVxuXG5cdCAgICBcdFx0dmFyIHBhdGggPSBkMy5nZW8ucGF0aCgpXG5cdCAgICBcdFx0XHRcdFx0LnByb2plY3Rpb24ocHJvamVjdGlvbilcblxuXG5cdCAgICBcdFx0ZDMuanNvbignbWFwZGF0YS93b3JsZC5qc29uJywgZnVuY3Rpb24gKGVyciwgZ2xvYmUpe1xuXHQgICAgXHRcdFx0dmFyIG5laWdoYm9ycyA9IHRvcG9qc29uLm5laWdoYm9ycyhnbG9iZS5vYmplY3RzLmNvdW50cmllcy5nZW9tZXRyaWVzKVxuXHQgICAgXHRcdFx0dmFyIGNvdW50cmllcyA9IHRvcG9qc29uLmZlYXR1cmUoZ2xvYmUsIGdsb2JlLm9iamVjdHMuY291bnRyaWVzKS5mZWF0dXJlc1xuXG5cdCAgICBcdFx0XHRzdmcuc2VsZWN0QWxsKFwiLmNvdW50cnlcIilcblx0XHRcdFx0ICAgIC5kYXRhKGNvdW50cmllcylcblx0XHRcdFx0ICAgIC5lbnRlcigpLmluc2VydChcInBhdGhcIilcblx0XHRcdCAgICBcdC5hdHRyKFwiY2xhc3NcIiwgXCJjb3VudHJ5XCIpXG5cdFx0XHQgICAgXHQuYXR0cihcImRcIiwgcGF0aClcblx0XHRcdCAgICBcdC5zdHlsZShcImZpbGxcIiwgZnVuY3Rpb24oZCwgaSkgeyByZXR1cm4gY29sb3IoZC5jb2xvciA9IGQzLm1heChuZWlnaGJvcnNbaV0sIGZ1bmN0aW9uKG4pIHsgcmV0dXJuIGNvdW50cmllc1tuXS5jb2xvcjsgfSkgKyAxIHwgMCk7IH0pO1xuXG5cdFx0XHRcdCAgXHRzdmcuaW5zZXJ0KFwicGF0aFwiKVxuXHRcdFx0XHQgICAgLmRhdHVtKHRvcG9qc29uLm1lc2goZ2xvYmUsIGdsb2JlLm9iamVjdHMuY291bnRyaWVzLCBmdW5jdGlvbihhLCBiKSB7IHJldHVybiBhICE9PSBiOyB9KSlcblx0XHRcdFx0ICAgIC5hdHRyKFwiY2xhc3NcIiwgXCJib3VuZGFyeVwiKVxuXHRcdFx0XHQgICAgLmF0dHIoXCJkXCIsIHBhdGgpO1xuXG5cblxuXG5cblxuXG5cdFx0XHRcdFx0XG5cdFx0XHRcdFx0Ly8gdmFyIHdvcmxkID0gc3ZnLmFwcGVuZCgnZycpXG5cdCAgICAvLyBcdFx0XHRcdC5zZWxlY3RBbGwoJ2cnKVxuXHQgICAgLy8gXHRcdFx0XHQuZGF0YSh0b3BvanNvbi5mZWF0dXJlKGdsb2JlLCBnbG9iZS5vYmplY3RzLnN1YnVuaXRzKS5mZWF0dXJlcylcblx0ICAgIC8vIFx0XHRcdFx0LmVudGVyKClcblx0ICAgIC8vIFx0XHRcdFx0LmFwcGVuZChcImdcIilcblxuXHQgICAgLy8gXHRcdFx0XHRjb25zb2xlLmxvZyhnbG9iZS5vYmplY3RzKVxuXG5cdFx0ICAgLy8gIFx0XHRcdHdvcmxkLmFwcGVuZCgncGF0aCcpXG5cdFx0ICAgLy8gIFx0XHRcdFx0LmF0dHIoJ2NsYXNzJywgJ3dvcmxkJylcblx0XHQgICAvLyAgXHRcdFx0XHQuYXR0cignZCcsIHBhdGgpO1xuXG5cdFx0ICAgLy8gIFx0XHRcdHN2Zy5hcHBlbmQoJ3BhdGgnKVxuXHRcdCAgIC8vICBcdFx0XHRcdC5kYXR1bSh0b3BvanNvbi5tZXNoKGdsb2JlLCBnbG9iZS5vYmplY3RzLnN1YnVuaXRzKSwgZnVuY3Rpb24oYSxiKSB7cmV0dXJuIGEhPT1ifSlcblx0XHQgICAvLyAgXHRcdFx0XHQuYXR0cignZCcsIHBhdGgpXG5cdFx0ICAgLy8gIFx0XHRcdFx0LmF0dHIoJ2NsYXNzJywgJ3N1YnVuaXQtYm91bmRhcnknKVxuXG5cdFx0ICAgIFx0XHRcdFxuXHQgICAgXHRcdH0pXG5cblx0ICAgIFx0fSlcblx0XHRcblxuXG4gICAgXHRcdFxuXHRcdFx0XHRcdFx0XHRcblx0XHRcdFx0XHRcdFxuXHRcdFx0fVxuXHR9XG59KSJdfQ==
